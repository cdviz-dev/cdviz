[env]
PG_LOCAL_PWD = "postgres-password"
PG_LOCAL_USER = "cdviz"
PG_LOCAL_URL = "postgres://{{env.PG_LOCAL_USER}}:{{env.PG_LOCAL_PWD}}@127.0.0.1:5432/{{env.PG_LOCAL_USER}}?search_path=public&sslmode=disable"

[tools]
# docker = "latest"
atlas = "1"

[tasks."plan"]
description = "update the migrations to reflect target `src/schema.sql`"
run = [
  "mise run :db-local_start-empty",
  "atlas migrate diff --env db-local",
  "atlas migrate lint --env db-local --latest 10",
  "atlas migrate validate --env db-local",
  "atlas migrate hash",
  "mise run :db-local_stop",
]

[tasks."apply"]
description = "apply the schema & data migrations"
run = "atlas migrate apply --env db-local"

# cmd: atlas schema apply --env local

[tasks."db-local_start-empty"]
description = "start a container for the local db (empty: no data, no schema)"
run = [
  "mise run :db-local_stop",
  """docker run --rm --name cdviz-db \
    -e \"POSTGRES_PASSWORD={{env.PG_LOCAL_PWD}}\" \
    -e \"POSTGRES_USER={{env.PG_LOCAL_USER}}\" \
    -p 5432:5432 \
    --health-cmd "pg_isready -U {{env.PG_LOCAL_USER}} -d {{env.PG_LOCAL_USER}}" \
    --health-interval 2s \
    --health-timeout 5s \
    --health-retries 5 \
    -d \
    timescale/timescaledb-ha:pg18
  """,
  "sleep 6 # wait for the container to be ready"
]

[tasks."db-local_start"]
description = "start a container for the local db with the migrations applied"
run = ["mise run :db-local_start-empty", "mise run :apply"]

[tasks."db-local_stop"]
description = "stop the container of the local db"
run = [
  # "docker stop cdviz-db || true",
  "docker rm -f cdviz-db || true",
]

[tasks."db-local_psql"]
description = "connect to the local db with psql"
run = [
  "echo password=$PG_LOCAL_PWD",
  "docker run -it --rm --network host postgres psql -h 127.0.0.1 --username {{env.PG_LOCAL_USER}} -d {{env.PG_LOCAL_USER}}",
]

[tasks."test"]
run = ["mise run :db-local_start", "mise run :db-local_stop"]

[tasks."ci"]
description = "set of tasks run by CI"
# TODO fix test, check, lint
depends = [":build_cdviz-db-migration"]
# run = [
#   "mise run :test",
#   # "mise run :check"
#   # "mise run :lint"
# ]

[tasks."list_containers"]
description = "list all containers images"
run = "docker image ls --tree --filter 'reference=*/*/cdviz-db*'"

[tasks."debug_bake"]
description = "show the 'resovled' bake definition"
run = [
  "docker info -f '{{ .DriverStatus }}'",
  "docker buildx bake --print",
]

[tasks."build_cdviz-db-migration"]
description = "build the docker image for the migration"
run = ["docker buildx bake --progress=plain cdviz-db-migration"]

[tasks."release_prepare"]
description = "Prepare release (calculate version & generate changelog)"
shell = "bash -c"
run = """
VERSION=$(mise run //:_release_version cdviz-db-migration "cdviz-db/**" VERSION)
mise run //:_release_changelog cdviz-db-migration "cdviz-db/**" "$VERSION"
echo "Prepared cdviz-db-migration $VERSION"
"""

[tasks."release_publish"]
description = "Build and publish container image to registry"
shell = "bash -c"
run = """
set -euo pipefail
VERSION=$(cat VERSION 2>/dev/null || echo "0.0.0")
NAME=cdviz-db-migration

if [[ "$VERSION" == "0.0.0" ]]; then
  echo "No VERSION file. Run release_prepare first."
  exit 1
fi

if git rev-parse "$NAME-$VERSION" >/dev/null 2>&1; then
  echo "$NAME $VERSION already published"
  exit 0
fi

echo "Publishing $NAME $VERSION..."
export MIGRATION_VERSION="$VERSION"
docker buildx bake --push "$NAME"

mise run //:_release_tag "$NAME" "$VERSION"
"""
