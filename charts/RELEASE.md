# Chart Release Process

Automated semantic versioning for Helm charts using git-cliff and mise.

## Overview

- **Versioning**: Pure SemVer (MAJOR.MINOR.PATCH) starting at 1.0.0
- **Unified Versioning**: All charts share the same version, one git tag per release
- **Automation**: git-cliff analyzes conventional commits to bump versions
- **Workflow**: Two-step process (prepare → review → publish)
- **Tools**: mise monorepo tasks + GitHub Actions

## Version Bumping Rules

| Commit Type | Example | Bump |
|-------------|---------|------|
| `feat:` | `feat(collector): add metrics endpoint` | MINOR (1.0.0 → 1.1.0) |
| `fix:` | `fix(db): resolve migration issue` | PATCH (1.0.0 → 1.0.1) |
| `feat!:` or `BREAKING CHANGE:` | `feat!: remove deprecated API` | MAJOR (1.0.0 → 2.0.0) |
| `chore(deps):` | `chore(deps): update helm to 3.x` | PATCH |
| Other | `docs:`, `chore:`, `refactor:` | No bump |

## Local Workflow

### Prepare Releases

```bash
# From project root - prepare all charts
mise run release:prepare-all

# Or prepare specific chart
cd charts/cdviz-collector
mise run :release:prepare

# Check what changed
git diff
```

This will:
1. Calculate next version using git-cliff
2. Update Chart.yaml (version + appVersion)
3. Generate/update CHANGELOG.md

### Publish Releases

```bash
# From project root - publish all charts
mise run release:publish-all

# Or publish specific chart
cd charts/cdviz-collector
mise run :release:publish
```

This will:
1. Check if version already published (skip if yes)
2. Package chart with helm
3. Push to `oci://ghcr.io/cdviz-dev/charts`
4. Create unified git tag `{version}` (e.g., `1.0.0`)
5. Push tag to remote

### Check Status

```bash
# From project root
mise run release:status
```

Shows current versions and whether they're published to OCI registry.

## GitHub Actions Workflow

### Step 1: Prepare (Automatic)

**Trigger**: Push to `main` branch with changes in `charts/`

**Actions**:
1. Runs `mise run release:prepare-all`
2. Creates PR with version/changelog updates
3. PR title: "chore(release): prepare chart releases"

**Review**: Check the PR to verify version bumps and changelogs are correct.

### Step 2: Publish (Automatic)

**Trigger**: Merge of PR with commit message starting with "chore(release):"

**Actions**:
1. Logs into ghcr.io
2. Runs `mise run release:publish-all`
3. Publishes charts to OCI registry
4. Creates git tags

## Initial Setup (One-Time)

After merging these changes, create initial tag to establish baseline:

```bash
git checkout main
git pull

# Create unified 1.0.0 tag for all charts
git tag -a 1.0.0 -m "Release charts 1.0.0"

# Push tag
git push origin 1.0.0
```

**Note**: All charts share the same version in this monorepo, so only one tag per release is needed.

## Unified Versioning Strategy

This monorepo uses unified versioning where all charts share the same version number:

- **One Tag Per Release**: Instead of per-chart tags (`cdviz-collector-1.0.0`), we use unified tags (`1.0.0`)
- **Synchronized Releases**: All charts are released together with the same version
- **Simpler Git History**: Easier to track releases with a single tag
- **git-cliff Compatibility**: Tag pattern `[0-9]+\.[0-9]+\.[0-9]+.*` matches version tags directly

When a change affects only one chart, all charts still bump to the same version. This simplifies dependency management and ensures the entire CDviz stack is always version-aligned.

## Files Created

```
.mise.toml                           # Root: monorepo tasks
cliff.toml                           # Updated: bump configuration
charts/
  cdviz-collector/
    mise.toml                        # Chart-specific tasks
    CHANGELOG.md                     # Generated by git-cliff
  cdviz-db/
    mise.toml
    CHANGELOG.md
  cdviz-grafana/
    mise.toml
    CHANGELOG.md
.github/workflows/
  release-prepare.yml                # Step 1: Create PR
  release-publish.yml                # Step 2: Publish
```

## Breaking Changes

To signal a breaking change, use one of:

```bash
# Option 1: Exclamation mark
git commit -m "feat!: remove deprecated webhook endpoint"

# Option 2: Footer
git commit -m "feat: new configuration format

BREAKING CHANGE: Config now uses YAML instead of JSON"
```

This will bump MAJOR version (e.g., 1.5.3 → 2.0.0).

## Troubleshooting

### No version bump detected

**Cause**: No conventional commits since last release, or commits are skipped types (chore, docs, etc.)

**Solution**: Ensure commits use conventional format:
- `feat:` for features
- `fix:` for bug fixes
- `chore(deps):` for dependency updates

### Chart already published

If `release:publish` says "already published", the version in Chart.yaml already exists in the OCI registry. Either:
1. The chart was already published (check tags: `git tag -l`)
2. Need to bump version again (add another commit and run `release:prepare`)

### Git cliff not found

```bash
# Install git-cliff
cargo install git-cliff
# or
brew install git-cliff
```

## Migration Notes

**Old system** (git describe):
- Versions: `0.5.0-16-g400b285`
- Not SemVer compliant
- Manual process

**New system** (git-cliff):
- Versions: `1.0.0`, `1.1.0`, `1.0.1`
- Pure SemVer
- Automated with conventional commits
- Two-step safety (prepare → review → publish)
