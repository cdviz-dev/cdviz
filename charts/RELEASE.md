# Chart Release Process

Automated semantic versioning for Helm charts using git-cliff and mise.

## Overview

- **Versioning**: Pure SemVer (MAJOR.MINOR.PATCH)
- **Per-Component Tags**: Each chart has its own version and git tag (e.g., `cdviz-collector-1.0.0`)
- **Minimum Version Floor**: Root `VERSION` file sets the minimum version for all components
- **Automation**: git-cliff analyzes conventional commits to bump versions
- **Workflow**: Two-step process (prepare → review → publish)
- **Tools**: mise monorepo tasks + GitHub Actions

## Version Bumping Rules

| Commit Type | Example | Bump |
|-------------|---------|------|
| `feat:` | `feat(collector): add metrics endpoint` | MINOR (1.0.0 → 1.1.0) |
| `fix:` | `fix(db): resolve migration issue` | PATCH (1.0.0 → 1.0.1) |
| `feat!:` or `BREAKING CHANGE:` | `feat!: remove deprecated API` | MAJOR (1.0.0 → 2.0.0) |
| `chore(deps):` | `chore(deps): update helm to 3.x` | PATCH |
| Other | `docs:`, `chore:`, `refactor:` | No bump |

## Local Workflow

### Prepare Releases

```bash
# From project root - prepare all charts
mise run release:prepare-all

# Or prepare specific chart
cd charts/cdviz-collector
mise run :release:prepare

# Check what changed
git diff
```

This will:
1. Calculate next version using git-cliff
2. Update Chart.yaml (version + appVersion)
3. Generate/update CHANGELOG.md

### Publish Releases

```bash
# From project root - publish all charts
mise run release:publish-all

# Or publish specific chart
cd charts/cdviz-collector
mise run :release:publish
```

This will:
1. Check if version already published (skip if yes)
2. Package chart with helm
3. Push to `oci://ghcr.io/cdviz-dev/charts`
4. Create component-specific git tag (e.g., `cdviz-collector-1.0.0`)
5. Push tag to remote

### Check Status

```bash
# From project root
mise run release:status
```

Shows current versions and whether they're published to OCI registry.

## GitHub Actions Workflow

### Step 1: Prepare (Automatic)

**Trigger**: Push to `main` branch with changes in `charts/`

**Actions**:
1. Runs `mise run release:prepare-all`
2. Creates PR with version/changelog updates
3. PR title: "chore(release): prepare chart releases"

**Review**: Check the PR to verify version bumps and changelogs are correct.

### Step 2: Publish (Automatic)

**Trigger**: Merge of PR with commit message starting with "chore(release):"

**Actions**:
1. Logs into ghcr.io
2. Runs `mise run release:publish-all`
3. Publishes charts to OCI registry
4. Creates git tags

## Initial Setup (One-Time)

After merging these changes, create initial tags to establish baseline:

```bash
git checkout main
git pull

# Create initial tags for all charts
git tag -a cdviz-collector-1.0.0 -m "Release cdviz-collector 1.0.0"
git tag -a cdviz-db-1.0.0 -m "Release cdviz-db 1.0.0"
git tag -a cdviz-grafana-1.0.0 -m "Release cdviz-grafana 1.0.0"

# Push tags
git push origin --tags
```

## Versioning Strategy

### Per-Component Versioning

Each chart has its own version and lifecycle:
- **Independent Releases**: Charts can be released independently
- **Component Tags**: Tags follow `{chart-name}-{version}` format (e.g., `cdviz-collector-1.0.0`)
- **Scoped Changelogs**: Each chart has its own CHANGELOG.md tracking only its changes

### Minimum Version Floor

The root `VERSION` file sets a minimum version for all components:

```bash
# VERSION file content
1.0.0
```

**Use cases:**
- **Alignment Signal**: When you need all components to be at a minimum version for compatibility
- **Major Releases**: Bump VERSION to force all components to a new major version
- **Breaking Changes**: Signal to users that older versions should not be mixed with newer ones

**How it works:**
1. git-cliff calculates the next version based on commits
2. The calculated version is compared with VERSION file
3. The higher version is used

**Example:**
- Current: `cdviz-collector-0.5.2`, `cdviz-db-0.5.1`
- VERSION file: `1.0.0`
- Next release: Both charts bump to at least `1.0.0`

## Files

```
VERSION                              # Minimum version floor for all components
cliff.toml                           # git-cliff configuration
charts/
  mise.toml                          # Aggregated tasks for all charts
  cdviz-collector/
    mise.toml                        # Chart-specific tasks
    CHANGELOG.md                     # Generated by git-cliff
  cdviz-db/
    mise.toml
    CHANGELOG.md
  cdviz-grafana/
    mise.toml
    CHANGELOG.md
.github/workflows/
  release-prepare.yml                # Step 1: Create PR
  release-publish.yml                # Step 2: Publish
```

## Breaking Changes

To signal a breaking change, use one of:

```bash
# Option 1: Exclamation mark
git commit -m "feat!: remove deprecated webhook endpoint"

# Option 2: Footer
git commit -m "feat: new configuration format

BREAKING CHANGE: Config now uses YAML instead of JSON"
```

This will bump MAJOR version (e.g., 1.5.3 → 2.0.0).

## Troubleshooting

### No version bump detected

**Cause**: No conventional commits since last release, or commits are skipped types (chore, docs, etc.)

**Solution**: Ensure commits use conventional format:
- `feat:` for features
- `fix:` for bug fixes
- `chore(deps):` for dependency updates

### Chart already published

If `release:publish` says "already published", the version in Chart.yaml already exists in the OCI registry. Either:
1. The chart was already published (check tags: `git tag -l`)
2. Need to bump version again (add another commit and run `release:prepare`)

### Git cliff not found

```bash
# Install git-cliff
cargo install git-cliff
# or
brew install git-cliff
```

## Migration Notes

**Old system** (git describe):
- Versions: `0.5.0-16-g400b285`
- Not SemVer compliant
- Manual process

**New system** (git-cliff):
- Versions: `1.0.0`, `1.1.0`, `1.0.1`
- Pure SemVer
- Automated with conventional commits
- Two-step safety (prepare → review → publish)
