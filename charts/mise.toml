[tools]
# docker = "latest"     # to build, to run containers, should be available for some of thoses tools
# dive = "latest"       # to explore content of image container
helm = "4.0.0"         # to check helm chart

# TODO upgrade version only if change in the context of the Dockerfile
# TODO sign container (see <https://www.sigstore.dev/how-it-works>)
# TODO sign chart (see <https://www.sigstore.dev/how-it-works>)

[tasks."release_prepare"]
description = "Prepare releases for all charts (update versions & changelogs)"
depends = ["//charts/...:release_prepare"]

[tasks."release_publish"]
description = "Publish all charts to OCI registry"
depends = ["//charts/...:release_publish"]
shell = "bash -c"
run = """
set -euo pipefail

# Get version from first chart (all charts share same version)
VERSION=$(yq .version charts/cdviz-collector/Chart.yaml)

# Check if tag already exists
if git rev-parse "$VERSION" >/dev/null 2>&1; then
  echo "‚è≠Ô∏è  Tag $VERSION already exists"
  exit 0
fi

# Create unified version tag
echo "üè∑Ô∏è  Creating unified tag: $VERSION"
git tag "$VERSION" -m "Release charts $VERSION"
git push origin "$VERSION"

echo "‚úÖ Published unified tag $VERSION"
"""

[tasks."release_status"]
description = "Show release status for all charts"
run = """
echo "=== Chart Release Status ==="
for chart in charts/cdviz-*/; do
  if [[ ! -f "$chart/Chart.yaml" ]]; then continue; fi
  name=$(basename "$chart")
  version=$(yq .version "$chart/Chart.yaml" 2>/dev/null || echo "N/A")
  if helm show chart "$CHARTS_OCI_REGISTRY/$name" --version "$version" &>/dev/null; then
    status="‚úÖ published"
  else
    status="‚ùå not published"
  fi
  echo "  $name: $version $status"
done
"""

[tasks.ci]
description = "set of tasks run by CI"
depends = ["//charts/...:ci"]
